#!/usr/bin/env bash
# E2E test environment setup script for SimCiv
# This script ensures all prerequisites are met for running E2E tests

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

echo "üîß SimCiv E2E Test Setup"
echo "========================"
echo ""

# Check if npm dependencies are installed
if [ ! -d "${PROJECT_ROOT}/node_modules" ]; then
    echo "üì¶ Installing npm dependencies..."
    cd "${PROJECT_ROOT}"
    npm install
else
    echo "‚úÖ npm dependencies already installed"
fi

# Check if Playwright is available
echo ""
echo "üåê Checking Playwright..."
if ! npx playwright --version &>/dev/null; then
    echo "üì• Installing Playwright..."
    npm install @playwright/test
fi

# Install Playwright browsers
echo ""
echo "üåê Installing Playwright browsers..."
npx playwright install chromium

# Build the client
echo ""
echo "üèóÔ∏è  Building client application..."
cd "${PROJECT_ROOT}"
npm run build

# Ensure screenshots directory exists
echo ""
echo "üìÅ Creating screenshots directory..."
mkdir -p "${PROJECT_ROOT}/e2e-screenshots"

# Start MongoDB if not already running
echo ""
echo "üçÉ Starting MongoDB..."
"${SCRIPT_DIR}/mongo" start

# Check if server is running on port 3000
echo ""
echo "üîç Checking if server is running on port 3000..."
if lsof -ti:3000 &>/dev/null; then
    echo "‚úÖ Server is already running on port 3000"
else
    echo "üöÄ Starting server..."
    cd "${PROJECT_ROOT}"
    npm start &
    SERVER_PID=$!
    
    # Wait for server to be ready
    echo "‚è≥ Waiting for server to be ready..."
    max_wait=30
    count=0
    while ! curl -s http://localhost:3000/ >/dev/null 2>&1 && [ $count -lt $max_wait ]; do
        sleep 1
        count=$((count + 1))
    done
    
    if curl -s http://localhost:3000/ >/dev/null 2>&1; then
        echo "‚úÖ Server is running on port 3000 (PID: $SERVER_PID)"
    else
        echo "‚ùå Server failed to start"
        exit 1
    fi
fi

# Build and start the game engine with test seed
echo ""
echo "üéÆ Setting up game engine..."
cd "${PROJECT_ROOT}/simulation"

# Build the engine if not already built or if source changed
if [ ! -f engine ] || [ pkg/engine/engine.go -nt engine ]; then
    echo "üèóÔ∏è  Building game engine..."
    go build -o engine main.go
fi

# Check if engine is already running
if pgrep -f "./engine" >/dev/null; then
    echo "‚úÖ Game engine is already running"
else
    echo "üöÄ Starting game engine with deterministic test seed..."
    export TEST_MAP_SEED="simciv-balanced-test-map"
    export MONGO_URI="${MONGO_URI:-mongodb://localhost:27017}"
    export DB_NAME="${DB_NAME:-simciv}"
    ./engine > /tmp/engine-e2e.log 2>&1 &
    ENGINE_PID=$!
    sleep 2
    if pgrep -f "./engine" >/dev/null; then
        echo "‚úÖ Game engine is running (PID: $ENGINE_PID)"
        echo "   Using deterministic seed for consistent map generation"
    else
        echo "‚ùå Game engine failed to start"
        echo "Check /tmp/engine-e2e.log for details"
        exit 1
    fi
fi

echo ""
echo "‚úÖ E2E test environment is ready!"
echo ""
echo "To run tests:"
echo "  npm run test:e2e"
echo ""
echo "To run tests in UI mode:"
echo "  npx playwright test --ui"
echo ""
echo "To run specific test:"
echo "  npx playwright test e2e/auth.spec.ts"
