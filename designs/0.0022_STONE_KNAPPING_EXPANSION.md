# SimCiv Minimal Simulator Expansion: Stone Knapping
## Adding a Second Technology to Validate Multi-Tech Simulation

### Document Status
**Version:** 0.0022  
**Status:** Design Proposal  
**Last Updated:** 2025-11-05  
**Purpose:** Specification for the smallest viable expansion of the minimal simulator to include a second technology

---

## Executive Summary

This document specifies the **smallest possible increment** to expand the minimal simulator's scope beyond Fire Mastery. The goal is to add production code for a second technology that is tested similarly to the existing Fire Mastery test.

**Key Decision: Stone Knapping**

After reviewing the technology tree designs and the existing minimal simulation, **Stone Knapping** is selected as the second technology because it:

1. **Simplest Addition**: Level 0 technology with no prerequisites (available immediately)
2. **Clear Game Impact**: Provides +20% food production bonus (via improved hunting/gathering efficiency)
3. **Tests Core Systems**: Validates the simulation can handle multiple technologies
4. **Minimal Code Changes**: Requires only ~50-100 lines of new production code
5. **Natural Progression**: Represents the next logical survival technology after fire

**Success Criteria:**

Both the existing Fire Mastery test and the new Stone Knapping test must pass, demonstrating that:
- Populations can research multiple technologies
- Technology effects stack correctly (Fire Mastery: +15% food, Stone Knapping: +20% food)
- The simulation remains viable with two research goals

---

## Rationale for Stone Knapping

### Why Stone Knapping (Not Another Tech)?

**Considered Alternatives:**

1. **Basic Foraging** - More complex, requires terrain-dependent logic
2. **Primitive Shelter Construction** - Requires shelter capacity mechanics
3. **Primitive Hunting** - Too similar to food production, less distinct benefit
4. **Natural Shelter Utilization** - Terrain-dependent

**Why Stone Knapping Wins:**

| Criterion | Stone Knapping | Alternatives |
|-----------|---------------|--------------|
| Prerequisites | None (Level 0) | None to minimal |
| Code Complexity | Low (simple multiplier) | Medium to high |
| Game Impact | Clear (+20% food) | Variable |
| Test Simplicity | Very simple | More complex |
| Distinct from Fire | Yes (tools vs. cooking) | Some overlap |

Stone Knapping provides the **minimal viable expansion** while introducing meaningful new functionality.

---

## Current State Analysis

### Existing Minimal Simulator (as of 0.0006)

**Technologies:**
- Fire Mastery (100 science points, +15% food production via cooking)

**Mechanics:**
- Food production: Base rate × terrain × fire bonus (if unlocked)
- Science production: Work hours × science rate × health modifier
- Population: 100 starting, with birth/death mechanics
- Default allocation: 70% food / 30% science

**Test Coverage:**
- 50 seed-based deterministic tests
- Fire Mastery typically unlocked in ~140 days (0.38 years)
- 100% viability rate with 70/30 allocation

### Gap: No Multi-Technology Testing

The current simulator has only one technology, so it cannot test:
- ✗ Multiple research goals
- ✗ Technology prerequisite chains
- ✗ Stacking technology bonuses
- ✗ Research prioritization decisions

---

## Design: Stone Knapping Addition

### Technology Specification (from 0.0004_TECH_TREE.md)

**Stone Knapping**
- **Level**: 0 (immediately available)
- **Prerequisites**: None
- **Research Cost**: 100 science points (same as Fire Mastery for symmetry)
- **Population Required**: 5 minimum (always satisfied with 100 starting pop)
- **Resource Requirements**: None (simplified - design mentions stone resources, omitted for minimal version)

**Effects:**
- +20% food gathering efficiency (applied to base food production)
- Stacks multiplicatively with Fire Mastery (+15%)
- Combined effect: 1.0 × 1.15 × 1.20 = 1.38 (+38% food production)

### Implementation Changes

#### 1. Update Technology State (types.go)

```go
// MinimalCivilizationState (add new field)
type MinimalCivilizationState struct {
    // ... existing fields ...
    
    // Technology
    HasFireMastery     bool // Research goal 1 (unlocks at 100 science)
    HasStoneKnapping   bool // Research goal 2 (unlocks at 100 science) [NEW]
    
    // ... existing fields ...
}
```

#### 2. Update Starting Conditions (simulator.go)

No changes needed - both technologies start as `false` (not unlocked).

#### 3. Update Food Production (mechanics.go)

```go
// produceFood calculates food production for the day
func produceFood(foodHours float64, hasFireMastery bool, hasStoneKnapping bool, terrainMultiplier float64) float64 {
    multiplier := 1.0
    
    if hasFireMastery {
        multiplier *= 1.15 // +15% from cooking
    }
    
    if hasStoneKnapping {
        multiplier *= 1.20 // +20% from better tools [NEW]
    }
    
    return foodHours * FoodBaseRate * multiplier * terrainMultiplier
}
```

#### 4. Add Technology Unlock Check (mechanics.go)

```go
// Constants (add to existing)
const (
    // ... existing constants ...
    
    StoneKnappingScienceRequired = 100.0 // [NEW]
)

// checkTechnologyUnlocks checks if any technologies should be unlocked [RENAMED from checkTechnologyUnlock]
func checkTechnologyUnlocks(state *MinimalCivilizationState) []string {
    unlocked := []string{}
    
    // Check Fire Mastery
    if !state.HasFireMastery && state.SciencePoints >= FireMasteryScienceRequired {
        state.HasFireMastery = true
        unlocked = append(unlocked, "Fire Mastery")
    }
    
    // Check Stone Knapping [NEW]
    if !state.HasStoneKnapping && state.SciencePoints >= StoneKnappingScienceRequired {
        state.HasStoneKnapping = true
        unlocked = append(unlocked, "Stone Knapping")
    }
    
    return unlocked
}
```

#### 5. Update Simulation Loop (simulator.go)

```go
// RunSimulation (update food production call)
foodProduction := produceFood(foodHours, state.HasFireMastery, state.HasStoneKnapping, config.StartingConditions.TerrainMultiplier)

// Update technology unlock check
techsUnlocked := checkTechnologyUnlocks(state)
if len(techsUnlocked) > 0 {
    // Technologies unlocked!
}
```

#### 6. Update Viability Criteria (simulator.go)

The viability criteria changes slightly:

**Original (Fire Mastery only):**
- Simulation runs until Fire Mastery unlocked OR max days

**New (Multiple Technologies):**
- Simulation runs until BOTH technologies unlocked OR max days
- Viability = both Fire Mastery AND Stone Knapping unlocked

```go
// Updated termination condition
if state.HasFireMastery && state.HasStoneKnapping {
    break // Both technologies unlocked - success!
}
```

---

## New Test Specification

### Test: Viability with Two Technologies

This test validates that populations can:
1. Survive long enough to research two technologies
2. Accumulate 200 science points (100 for each tech)
3. Benefit from both technology bonuses
4. Maintain viability with stacked bonuses

**Expected Behavior:**

With 70/30 food/science allocation:
- Fire Mastery unlocks at ~140 days (unchanged)
- Stone Knapping unlocks at ~140 days (same science cost)
- Both unlock simultaneously at ~140 days (200 science points)
- Combined food bonus (+38%) helps maintain population
- Test passes if both techs unlocked within 10 years

**Test Implementation:**

```go
// TestViabilityWithTwoTechnologies tests that populations can research both technologies
func TestViabilityWithTwoTechnologies(t *testing.T) {
    conditions := DefaultStartingConditions()
    
    viableCount := 0
    bothTechsCount := 0
    
    for _, seed := range VIABILITY_TEST_SEEDS {
        config := SimulationConfig{
            Seed:               seed,
            StartingConditions: conditions,
            MaxDays:            3650, // 10 years
        }
        
        result := RunSimulation(config)
        
        if result.IsViable {
            viableCount++
        }
        
        if result.HasFireMastery && result.HasStoneKnapping {
            bothTechsCount++
        }
    }
    
    // Both technologies should be researched in 100% of viable runs
    if bothTechsCount != len(VIABILITY_TEST_SEEDS) {
        t.Errorf("Expected all 50 seeds to unlock both technologies, got %d/%d", 
            bothTechsCount, len(VIABILITY_TEST_SEEDS))
    }
    
    // Viability rate should remain 100% with two technologies
    if viableCount != len(VIABILITY_TEST_SEEDS) {
        t.Errorf("Expected 100%% viability with two technologies, got %d/%d viable",
            viableCount, len(VIABILITY_TEST_SEEDS))
    }
}
```

### Test: Technology Bonus Stacking

This test validates that bonuses from both technologies stack correctly:

```go
// TestTechnologyBonusStacking tests that Fire Mastery and Stone Knapping bonuses stack
func TestTechnologyBonusStacking(t *testing.T) {
    baseFood := 100.0
    terrain := 1.0
    
    tests := []struct {
        name              string
        hasFireMastery    bool
        hasStoneKnapping  bool
        expectedMultiplier float64
    }{
        {"No technologies", false, false, 1.0},
        {"Fire Mastery only", true, false, 1.15},
        {"Stone Knapping only", false, true, 1.20},
        {"Both technologies", true, true, 1.38}, // 1.15 * 1.20 = 1.38
    }
    
    for _, tt := range tests {
        t.Run(tt.name, func(t *testing.T) {
            result := produceFood(baseFood, tt.hasFireMastery, tt.hasStoneKnapping, terrain)
            expected := baseFood * tt.expectedMultiplier
            
            epsilon := 0.01
            if result < expected-epsilon || result > expected+epsilon {
                t.Errorf("Expected %f, got %f", expected, result)
            }
        })
    }
}
```

---

## Expected Simulation Behavior

### Timeline with Two Technologies

**Starting Conditions:**
- Population: 100
- Average health: 40
- Food stockpile: 100
- Science points: 0
- Food allocation: 70%

**Day 1-140: Pre-Technology Era**
- Food production: ~280 units/day (base rate)
- Food consumption: ~200 units/day (100 people)
- Net food: +80 units/day (surplus building)
- Science accumulation: ~0.72 points/day
- Population: Stable to growing (births > deaths)

**Day 140: Both Technologies Unlock**
- Fire Mastery unlocked at 100 science points
- Stone Knapping unlocked at 100 science points
- Combined bonus: +38% food production
- Food production: ~387 units/day (was 280)
- Net food: +187 units/day (massive surplus)

**Day 141-3650: Post-Technology Era**
- Population grows rapidly with food surplus
- Health increases (better nutrition)
- Excess food enables higher science allocation (if implemented)
- Simulation continues to demonstrate long-term viability

**Expected Final Metrics (Day 3650 = 10 years):**
- Population: 120-150 (steady growth)
- Average health: 60-70 (well-fed)
- Food stockpile: 10,000+ (massive surplus)
- Science points: 200+ (if continued research)
- Both technologies: Unlocked ✓

---

## Backward Compatibility

### Existing Tests Must Still Pass

All existing tests remain valid and must pass:

1. ✓ `TestRandomGenerator_*` - Unchanged
2. ✓ `TestInitializePopulation` - Unchanged
3. ✓ `TestCalculateAvailableLabor` - Unchanged
4. ✓ `TestAllocateLabor` - Unchanged
5. ✓ `TestProduceFood` - **Updated signature** (add hasStoneKnapping parameter)
6. ✓ `TestProduceScience` - Unchanged
7. ✓ `TestConsumeFood` - Unchanged
8. ✓ `TestUpdateHealth` - Unchanged
9. ✓ `TestCheckMortality` - Unchanged
10. ✓ `TestCheckReproduction` - Unchanged
11. ✓ `TestSimulation_BasicRun` - Unchanged
12. ✓ `TestViabilityWithMultipleSeeds` - **Updated criteria** (both techs)
13. ✓ `TestViabilityStatistics` - Unchanged
14. ✓ `TestHarshTerrain` - Unchanged
15. ✓ `TestGoodTerrain` - Unchanged
16. ✓ `TestFoodAllocationComparison` - Unchanged

**Migration Strategy:**

Existing tests that call `produceFood()` need updated signatures:
```go
// Old
produceFood(hours, hasFireMastery, terrain)

// New
produceFood(hours, hasFireMastery, false, terrain) // false = no Stone Knapping yet
```

---

## Code Changes Summary

### Files to Modify

1. **types.go**
   - Add `HasStoneKnapping bool` field to `MinimalCivilizationState`
   - ~1 line added

2. **mechanics.go**
   - Add `StoneKnappingScienceRequired` constant
   - Update `produceFood()` signature and logic
   - Rename `checkTechnologyUnlock()` to `checkTechnologyUnlocks()`
   - Update unlock logic to check both technologies
   - ~15 lines modified, ~10 lines added

3. **simulator.go**
   - Update food production call in main loop
   - Update technology unlock check
   - Update viability termination condition
   - ~5 lines modified

4. **simulator_test.go**
   - Update `TestProduceFood` test cases for new signature
   - Add `TestTechnologyBonusStacking` test
   - Add `TestViabilityWithTwoTechnologies` test
   - Update `TestViabilityWithMultipleSeeds` to check both technologies
   - ~30 lines modified, ~60 lines added

**Total Code Changes:** ~120 lines (60 production code, 60 test code)

---

## Validation Criteria

### The implementation is successful if:

1. **All Existing Tests Pass**
   - No regressions in current functionality
   - Backward compatibility maintained

2. **New Tests Pass**
   - `TestTechnologyBonusStacking` validates correct bonus calculation
   - `TestViabilityWithTwoTechnologies` validates dual-tech research

3. **50-Seed Viability**
   - All 50 predefined seeds achieve both technologies
   - 100% viability rate maintained
   - Technologies unlock in reasonable time (<1 year typical)

4. **Code Quality**
   - Clean, readable implementation
   - Follows existing code patterns
   - Well-commented for future expansion

---

## Future Expansion Path

This minimal expansion establishes patterns for adding more technologies:

### Phase 2: Third Technology (Future)
- Add Basic Foraging or Primitive Hunting
- Test three simultaneous technologies
- Different science costs (e.g., 50, 100, 150)

### Phase 3: Tech Prerequisites (Future)
- Add Level 1 technology (e.g., Advanced Tool-Making)
- Requires Stone Knapping prerequisite
- Test prerequisite validation logic

### Phase 4: Research Queue (Future)
- Allow player/AI to choose research order
- Multiple techs in progress simultaneously
- Research prioritization strategies

---

## Design Rationale

### Why This Is the "Smallest Increment"

**What Makes This Minimal:**

1. **Single Technology Added**: Only one new tech (Stone Knapping)
2. **No New Mechanics**: Uses existing science accumulation system
3. **Simple Effect**: Food production multiplier (like Fire Mastery)
4. **No Prerequisites**: Both techs available immediately
5. **Same Science Cost**: 100 points each (symmetric design)
6. **Minimal Code**: ~60 lines of production code
7. **Reuses Tests**: Existing test framework extended

**What This Validates:**

1. ✓ Multiple technology tracking
2. ✓ Technology effect stacking
3. ✓ Simultaneous technology unlocks
4. ✓ Enhanced food production benefits
5. ✓ Long-term population viability

**What This Defers (Future Work):**

- ✗ Technology prerequisites
- ✗ Different science costs per tech
- ✗ Research queue/prioritization
- ✗ More complex tech effects (unit unlocks, building types)
- ✗ Terrain/resource requirements
- ✗ Level 1+ technologies

---

## Implementation Notes

### Development Sequence

1. **Update Types** - Add Stone Knapping field (~5 minutes)
2. **Update Mechanics** - Modify food production and unlock logic (~15 minutes)
3. **Update Simulator** - Integrate new tech into main loop (~10 minutes)
4. **Update Tests** - Fix signature changes (~10 minutes)
5. **Add New Tests** - Technology stacking and dual-tech viability (~20 minutes)
6. **Run Full Test Suite** - Validate all 50 seeds (~5 minutes)
7. **Document Results** - Update test output documentation (~10 minutes)

**Total Estimated Development Time:** 75 minutes

### Testing Strategy

**Unit Tests (New):**
- `TestTechnologyBonusStacking` - Validates food calculation correctness

**Integration Tests (Updated):**
- `TestViabilityWithMultipleSeeds` - Both techs unlocked in all 50 seeds
- `TestViabilityWithTwoTechnologies` - New test for dual-tech research

**Regression Tests (Existing):**
- All existing tests must pass with updated signatures

---

## Success Metrics

### Quantitative Metrics

| Metric | Target | Rationale |
|--------|--------|-----------|
| Viability Rate | 100% (50/50 seeds) | Both technologies achievable |
| Days to Both Techs | ~140 days | Same as single Fire Mastery |
| Test Pass Rate | 100% (all tests) | No regressions |
| Code Coverage | >90% | Well-tested implementation |
| Population Growth | Positive | Technologies help survival |

### Qualitative Metrics

1. **Code Clarity**: New code follows existing patterns
2. **Test Clarity**: Tests clearly document expected behavior
3. **Maintainability**: Easy to add third technology
4. **Documentation**: Design rationale clearly explained

---

## Related Documents

- **0.0004_TECH_TREE.md**: Full technology tree specification (Stone Knapping details)
- **0.0006_MINIMAL_SIMULATOR.md**: Current minimal simulator design (Fire Mastery only)
- **0.0018_VICTORY_PROGRESSION_TREES.md**: Four tree system overview
- **PREHISTORY_TREES.md**: Prehistoric technology progression overview

---

## Conclusion

This design specifies the **smallest possible increment** to expand the minimal simulator beyond Fire Mastery. By adding Stone Knapping as a second Level 0 technology, we:

1. **Test Multi-Technology Systems**: Validate that the simulator can handle multiple research goals
2. **Test Technology Stacking**: Ensure bonuses from different technologies combine correctly
3. **Minimize Code Changes**: ~60 lines of production code, ~60 lines of test code
4. **Maintain Quality**: All existing tests pass, new tests added
5. **Enable Future Growth**: Establishes patterns for adding more technologies

**Key Design Decisions:**

- Stone Knapping chosen over alternatives for simplicity
- Same science cost (100 points) as Fire Mastery for symmetry
- Food production bonus (+20%) distinct from Fire Mastery (+15%)
- Both technologies unlock simultaneously at 200 science points
- Viability criteria updated to require both technologies

**Expected Outcome:**

After this expansion, the minimal simulator will demonstrate:
- Populations can research multiple technologies
- Technology effects stack correctly
- Simulation remains viable with enhanced capabilities
- Code is ready for further technology additions

This expansion represents a **focused, testable, incremental improvement** that validates core multi-technology systems while maintaining the minimal simulator's simplicity and reliability.

---

**Document Version:** 0.0022  
**Implementation Status:** Design Proposal (Not Yet Implemented)  
**Next Steps:** 
1. Review and approve this design
2. Implement code changes as specified
3. Run full test suite (all 50 seeds)
4. Document results and update design if needed
